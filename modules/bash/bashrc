export EDITOR=nvim
PROMPT_DIRTRIM=3

# Shell options
shopt -s autocd       # Type directory name to cd into it
shopt -s cdspell      # Autocorrect typos in cd
shopt -s dirspell     # Autocorrect directory names in completion
shopt -s histappend   # Append to history, don't overwrite
shopt -s cmdhist      # Save multi-line commands as one entry
shopt -s globstar     # Enable ** recursive glob
shopt -s checkwinsize # Update LINES/COLUMNS after commands

# Auto-start tmux in allowed terminals
allowed_terminals="ghostty"
if [[ -z "$TMUX" && -n "$TERM" && "$TERM" != *tmux* ]]; then
    for term in $allowed_terminals; do
        if [[ "$TERM_PROGRAM" == "$term" ]]; then
            if command -v tmux &> /dev/null; then
                exec tmux
            fi
        fi
    done
fi

# Aliases for eza/ls
if command -v eza &> /dev/null; then
    alias l='eza'
    alias ls='eza'
    alias ll='eza -l'
    alias lll='eza -la'
else
    alias l='ls'
    alias ll='ls -l'
    alias lll='ls -la'
fi

# Zoxide and fzf are configured via home-manager (programs.zoxide, programs.fzf)
# This ensures they initialize at the correct point in the shell startup

# Git prompt
if [[ -f /run/current-system/sw/share/bash-completion/completions/git-prompt.sh ]]; then
    source /run/current-system/sw/share/bash-completion/completions/git-prompt.sh
elif [[ -f /etc/bash_completion.d/git-prompt ]]; then
    source /etc/bash_completion.d/git-prompt
elif [[ -f /usr/share/git-core/contrib/completion/git-prompt.sh ]]; then
    source /usr/share/git-core/contrib/completion/git-prompt.sh
fi

GIT_PS1_SHOWDIRTYSTATE=1
GIT_PS1_SHOWUNTRACKEDFILES=1

# Prompt: shortened path + git info
__prompt_command() {
    local git_info=""
    if command -v __git_ps1 &> /dev/null; then
        git_info=$(__git_ps1 " (%s)")
    fi
    PS1="\w${git_info} \$ "
}
PROMPT_COMMAND=__prompt_command

# Open file:line from command output in nvim
# Usage: make test 2>&1 | vf
# Supports file.ext:line and file.ext(line,col) formats
vf() {
    if [[ -t 0 ]]; then
        echo "Usage: command 2>&1 | vf"
        return 1
    fi
    local selection file line tmpfile
    tmpfile=$(mktemp)
    tee "$tmpfile"
    selection=$(grep -oE '[^ "]+\.[a-zA-Z]+[:\(][0-9]+' "$tmpfile" | sed 's/(/:/' | fzf --height 40%)
    rm -f "$tmpfile"
    if [[ -n "$selection" ]]; then
        file="${selection%%:*}"
        line="${selection##*:}"
        nvim "+$line" "$file"
    fi
}
